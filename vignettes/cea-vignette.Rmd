---
title: "*cea*: An R package for cost-effectiveness analysis"
author: "Devin Incerti"
date: "`r Sys.Date()`"
output: 
  html_document:
bibliography: cea-references.bib
---

```{r echo=FALSE}
knitr::read_chunk('cea-vignette.R')
```

## Introduction
Cost-effectiveness modeling tends to be performed in commercial packages (such as TreeAge) or using Microsoft Excel. However, as others have pointed out [@baio2016excel], general purpose programming languages offer a number of advantages over Excel and other commonly used software. For example, R offers the following functionality.

* Reproducibility
* Generalizability
* Integration of statistical and economic models
* Speed and computational power
* Creation of interactive web applications

The *cea* package aims to help health economists and economic modelers realize this functionality. The package can be easily integrated with existing packages for survival analysis (*survival*) and multi-state modeling (*msm*, *mstate*). Users should also explore the excellent *BCEA* package. 

*cea* is designed for both Bayesian cost-effectiveness analysis (CEA) and patient-level simulation. As such, the computationally heavy code is written in C++ using the *Rcpp* package. Likewise, it makes extensive use of the *data.table* package for fast data manipulation. This speed is especially beneficial when performing probabilistic sensitivity analysis (PSA) with a patient-level simulation models.


## Decision Analysis
### Theory
Decision analysis provides a formal framework for making treatment decisions based on the utility that a therapy provides to a patient population. Traditionally, decision rules state that for  parameters $\theta$, the optimal treatment arm, $j^{*}$, is the one that maximizes expected net benfit,

$$
\begin{aligned}
j^{*} = \text{argmax}_j E_\theta NB(j,\theta).
\end{aligned}
$$

Typically, the net benefit is defined as the difference between the monetized health gains from an intervention less costs, or,

$$
\begin{aligned}
NB(j,\theta) = e\cdot w - c,
\end{aligned}
$$

where $e$ is a measure of clinical effectiveness (e.g. QALYs), $w$ is the value or willingess to pay per unit of effectiveness, and c is costs. Decision makers are typically concerned with expected outcomes, so $e$ and $c$ are usually average (rather than say medians). Separate treatment decision can be made for each patient or for subgroups of patients, although it is most common for decisions to be made uniformly for all patients. 

In PSA, the distribution of net benefits is estimated using the distribution of parameters, $\theta$. In other words, the distribution of model inputs is used to produce a distribution of model outputs. Since the joint distribution of the model parameters cannot be derived analytically (except in the simplest of cases), the distribution of $\theta$ approximated using either Bayesian or quasi-Bayesian techniques. That is, in what is often referred to as an "outer loop", $\theta$ is randomly sampled from its joint distribution, and for each random draw, the cost-effectiveness model is simulated, which generates a random sample of model outputs. The output can then be used to form a random sample of size n from the distribution of $e$ and $c$,

$$
\begin{aligned}
e &= [e^1, e^2, \dots, e^n] \\
c &= [c^1, c^2, \dots, c^n],
\end{aligned}
$$

$e^s$ and $c^s$ are $s$th random sample of effectiveness (QALYs) and costs respectively. For example, we can simulate results from three hypothetical treatments. We use $1$ to refer to the existing therapy, and $2$, and $3$ to refer to competing treatment arms.

```{r ce_output}
```

For a given willingess to pay $k$, it is quite easy to determine the optimal treatment by estimating the expected net benefit for each arm. For example, for $W = 150,000$, which is a reasonable estimate of the value of a life-year in the United States, we can calculate, $\text{E}[e] \cdot w - \text{E}[c]$ 

```{r enb_example}
```

The expected net benefit is largest for arm 3, which implies that if the willingess to pay for a QALY is $150,000, patients should switch to this new treatment. Of course, this analysis ignores uncertainty in $e$ and $c$. We might for instance, be interested in estimating the probability that each treatment is optimal. The function `mce` makes this calculation for various values of $k$. Output is a tidy *data.table*, which facilitates plotting with *ggplot2*.

```{r pcea}
```

```{r mce_plot}
```

However, the previous figure does not account for the magnitude of cost or QALY gains. A measure which combines the probability of being most effective with the magnitude of the expected net benefit is the expected value of perfect information (EVPI). Intuitively, the EVPI provides an estimate of the amount that we would be willing to pay to collect additional data and completely eliminate uncertainty. Mathematically, the EVPI is defined as the difference between the expected net benefit given perfect information (ENBPI) and the expected net benefit (ENB),

$$
\begin{aligned}
EVPI &= \int_s NB(j^{s*}, \theta^s) - NB(j^{*}, \theta^s) \\
&= ENBPI - ENB
\end{aligned}
$$

# ```{r evpi}
# ```

In most analyses, the analyst will want estimates of the probability that each treatment is most cost-effective and and EVPI. The function ``psa`` is a wrapper for the ``evpi`` and ``mce`` functions. It also provides a summary table of means and credible intervals for both QALYs and costs. Finally, the user has the option to specify a custom table of summary output. The custom table can contain any quantities of interest (QOIs) as long as they are specified in addition to the sim, arm, e, and c columns in the posterior distribution data table. The default is to estimate means, the 2.5% quantile, and the 97.5% quantile for each variable, but any custom function can used. Below, we create a hyothetical variable for life-years and create table summarizing our estimates of costs, QALYs and life-years. A custom function, identical to the default option, is entered into the function for illustrative purposes.

# ```{r psa}
# ```

### Pairwise comparisons

### Individualized care

### Comparson with BCEA

## Simulating Disease Progression 

## References

