---
title: "*cea*: An R package for cost-effectiveness analysis"
author: "Devin Incerti"
date: "`r Sys.Date()`"
output: 
  html_document:
bibliography: cea-references.bib
---

```{r echo=FALSE}
knitr::read_chunk('cea-vignette.R')
```

## Introduction
Cost-effectiveness modeling tends to be performed in commercial packages (such as TreeAge) or using Microsoft Excel. However, as others have pointed out [@baio2016excel], general purpose programming languages offer a number of advantages over Excel and other commonly used software. For example, R offers the following functionality.

* Reproducibility
* Generalizability
* Integration of statistical and economic models
* Speed and computational power
* Creation of interactive web applications

The *cea* package aims to help health economists and economic modelers realize this functionality. The package can be easily integrated with existing packages for survival analysis (*survival*) and multi-state modeling (*msm*, *mstate*). Users should also explore the excellent *BCEA* package. 

*cea* is designed for both Bayesian cost-effectiveness analysis (CEA) and patient-level simulation. As such, the computationally heavy code is written in C++ using the *Rcpp* package. Likewise, it makes extensive use of the *data.table* package for fast data manipulation. This speed is especially beneficial when performing probabilistic sensitivity analysis (PSA) with a patient-level simulation models.


## Decision Analysis

### Net Benefits
Decision analysis provides a formal framework for making treatment decisions based on the utility that a therapy provides to a patient population. Traditionally, decision the optimal treatment arm is the one that maximizes expected net benfit. The expected net benefit is calculated by averaging over the patient population and uncertain parameters $\theta$. If the population is broken up into distinct subgroups, then the optimal treatment $j^{*}$ is given by,

$$
\begin{aligned}
j^{*} = \text{argmax}_j \int_s \int_\theta w_s NB_s(j,\theta),
\end{aligned}
$$
where $w_s \in (0, 1)$ is a weight denoting that proportion of the population represented by subgroup $s$ and $\sum_{s=1}^{S} w_s = 1$. Net benefits in each subgroup are computed as the difference between the monetized health gains from an intervention less costs, or,

$$
\begin{aligned}
NB_s(j,\theta) = e_s\cdot k- c_s,
\end{aligned}
$$

where $e_s$ and $c_s$ are a measure of clinical effectiveness (e.g. QALYs) and costs in subgroup $s$ respecively, and $k$ is a decision makers willingess to pay per unit of effectiveness. 

Expected net benefits can be increased by selecting separate treatments in each subgroup instead of a single treatment for the entire population. That is, the decision maker should choose the treatment that maximizes net benefits in each subgroup,

$$
\begin{aligned}
j^{*}_s = \text{argmax}_j \int_\theta NB_s(j,\theta).
\end{aligned}
$$
[@basu2007value] have shown that the increased in expected net benefit from this individualized care, which they call the expected value of individualized care (EPIC) is commputed as,

$$
\begin{aligned}
\int_s \int_\theta NB_s(j^{*}_s,\theta) - \int_s \int_\theta NB_s(j^{*},\theta).
\end{aligned}
$$

### Probabilistic sensitivity analysis

One drawback of basing analysis purely on expected values is that it ignores uncertainty in the parameters. 

In PSA, the distribution of net benefits is estimated using the distribution of parameters, $\theta$. In other words, the distribution of model inputs is used to produce a distribution of model outputs. Since the joint distribution of the model parameters cannot be derived analytically (except in the simplest of cases), the distribution of $\theta$ approximated using either Bayesian or quasi-Bayesian techniques. That is, in what is often referred to as an "outer loop", $\theta$ is randomly sampled from its joint distribution, and for each random draw, the cost-effectiveness model is simulated, which generates a random sample of model outputs. The output can then be used to form a random sample of size n from the distribution of $e$ and $c$,

$$
\begin{aligned}
e &= [e^1, e^2, \dots, e^n] \\
c &= [c^1, c^2, \dots, c^n],
\end{aligned}
$$

$e^s$ and $c^s$ are $s$th random sample of effectiveness (QALYs) and costs respectively. For example, we can simulate results from three hypothetical treatments. We use $1$ to refer to the existing therapy, and $2$, and $3$ to refer to competing treatment arms. 

```{r ce_output}
```

For a given willingess to pay $k$, it is quite easy to determine the optimal treatment by estimating the expected net benefit for each arm. For example, for $W = 150,000$, which is a reasonable estimate of the value of a life-year in the United States, we can calculate, $\text{E}[e] \cdot w - \text{E}[c]$ 

```{r enb_example}
```

The expected net benefit is largest for arm 3, which implies that if the willingess to pay for a QALY is $150,000, patients should switch to this new treatment. 


Of course, this analysis ignores uncertainty in $e$, $c$, and the willingess to pay threshold. We might for instance, be interested in estimating the probability that each treatment is optimal.

However, this caclulation ignores the magnitude of cost or QALY gains. A measure which combines the probability of being most effective with the magnitude of the expected net benefit is the expected value of perfect information (EVPI). Intuitively, the EVPI provides an estimate of the amount that we would be willing to pay to collect additional data and completely eliminate uncertainty. Mathematically, the EVPI is defined as the difference between the expected net benefit given perfect information (ENBPI) and the expected net benefit (ENB),

$$
\begin{aligned}
EVPI &= \int_s NB(j^{s*}, \theta^s) - NB(j^{*}, \theta^s) \\
&= ENBPI - ENB
\end{aligned}
$$

The function `pcea` makes this calculation for various values of $k$. Output is a tidy *data.table*, which facilitates plotting with *ggplot2*.

```{r pcea}
```

MCE plot
```{r mce_plot, fig.cap = "Probability each arm is most cost-effective by subgroup"}
```

EVPI plot

```{r evpi_plot, fig.cap = "Expected value of perfect information by subgroup"}
```

In most analyses, the analyst will want estimates of the probability that each treatment is most cost-effective and and EVPI. The function ``psa`` is a wrapper for the ``evpi`` and ``mce`` functions. It also provides a summary table of means and credible intervals for both QALYs and costs. Finally, the user has the option to specify a custom table of summary output. The custom table can contain any quantities of interest (QOIs) as long as they are specified in addition to the sim, arm, e, and c columns in the posterior distribution data table. The default is to estimate means, the 2.5% quantile, and the 97.5% quantile for each variable, but any custom function can used. Below, we create a hyothetical variable for life-years and create table summarizing our estimates of costs, QALYs and life-years. A custom function, identical to the default option, is entered into the function for illustrative purposes.

```{r pcea_pw}
```

Cost-effectiveness plane

```{r ceplane_plot, fig.cap = "Cost-effectiveness plane by subgroup"}
```

Cost-effectiveness acceptability curve

```{r ceac_plot, fig.cap = "Cost-effectiveness acceptability curve by subgroup"}
```

ICER

```{r icer}
```

### Pairwise comparisons

## Simulating Disease Progression 

## References

