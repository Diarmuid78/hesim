---
title: "*cea*: An R package for cost-effectiveness analysis"
author: "Devin Incerti"
date: "`r Sys.Date()`"
output: 
  html_document:
bibliography: cea-references.bib
---

```{r echo=FALSE}
knitr::read_chunk('cea-vignette.R')
```

## Introduction
Cost-effectiveness modeling tends to be performed in commercial packages (such as TreeAge) or using Microsoft Excel. However, as others have pointed out [@baio2016excel], general purpose programming languages offer a number of advantages over Excel and other commonly used software. For example, R offers the following functionality.

* Reproducibility
* Generalizability
* Integration of statistical and economic models
* Speed and computational power
* Creation of interactive web applications

The *cea* package aims to help health economists and economic modelers realize this functionality. The package can be easily integrated with existing packages for survival analysis (*survival*) and multi-state modeling (*msm*, *mstate*). Users should also explore the excellent *BCEA* package. 

*cea* is designed for both Bayesian cost-effectiveness analysis (CEA) and patient-level simulation. As such, the computationally heavy code is written in C++ using the *Rcpp* package. Likewise, it makes extensive use of the *data.table* package for fast data manipulation. This speed is especially beneficial when performing probabilistic sensitivity analysis (PSA) with a patient-level simulation models.


## Decision Analysis

### Net Benefits
Decision analysis provides a formal framework for making treatment decisions based on the utility that a therapy provides to a patient population. Traditionally, the optimal treatment arm is the one that maximizes expected net benfit. The expected net benefit is calculated by averaging over the patient population and uncertain parameters $\theta$. If the population is broken up into $S$ distinct subgroups, then the optimal treatment $j^{*}$ is given by,

$$
\begin{aligned}
j^{*} = \text{argmax}_j \sum_{s=1}^{S} w_s E_{\theta}\left[NB_s(j,\theta)\right],
\end{aligned}
$$
where $w_s \in (0, 1)$ is a weight denoting that proportion of the population represented by subgroup $s$ and $\sum_{s=1}^{S} w_s = 1$. Net benefits in each subgroup are computed as the difference between the monetized health gains from an intervention less costs, or,

$$
\begin{aligned}
NB_s(j,\theta) = e_{sj}\cdot k- c_{sj},
\end{aligned}
$$

where $e_{sj}$ and $c_{sj}$ are measures of clinical effectiveness (e.g. QALYs) and costs in subgroup $s$ using treatment $j$ respecively, and $k$ is a decision makers willingess to pay per unit of clinical effectiveness.

The current analysis ignores any heterogeneity in treatment effects since it assumes that decision makers will choose a single treatment for the entire population. Decision makers could instead select the treatment that maximizes net benefits in each subgroup,

$$
\begin{aligned}
j^{*}_s = \text{argmax}_j E_{\theta} \left[NB_s(j,\theta)\right].
\end{aligned}
$$

[@basu2007value] have shown that selecting subgroup specific treatments increases expected net benefits relative to choosing a single treatment for the entire population. They refer to additional net benefit as the expected value of individualized care (EPIC), which is computed as,

$$
\begin{aligned}
\sum_{s=1}^S w_s E_{\theta}\left[NB_s(j^{*}_s,\theta)\right] - \sum_{s=1}^S w_s  E_{\theta}\left[NB_s(j^{*},\theta)\right].
\end{aligned}
$$

In practice, new interventions are usually compared to a standard treatment often referred to as the comparator. In these cases, a new treatment in a given subgroup is preferred to the comparator if the expected incremental net benefit of the new treatment is positive; that is, treatment 1 is preferred to treatment 0 in subgroup $s$ if $EINB_s > 0$ where the incremental net benefit (INB) is given by

$$
\begin{aligned}
INB_s = NB_s(j = 1, \theta)] - NB_s(j = 0, \theta),
\end{aligned}
$$
and $EINB_s =E_\theta \left[INB_s\right]$. Equivalently, treatment $1$ is preferred to treatment $0$ in subgroup $s$ if the incremental cost-effectiveness ratio (ICER) is greater than the willingess to pay $k$,

$$
\begin{aligned}
k > \frac{c_{s1} - c_{s0}}{e_{s1} - e_{s0}} = ICER_s.
\end{aligned}
$$



### Probabilistic sensitivity analysis

The current analysis is based entirely on expected values and ignores parameter uncertainty. This implies that net benefits are uncertain and that optimal treatment arms amy be selected incorrectly. The extent of this uncertainty and the benefits of collecting additional information to reduce this uncertainty can be quantified using probabilistic sensitivity analysis (PSA), which estimates the distribution of net benefits given the distribution of the parameters for each treatment arm, $p\left(NB_s(j,\theta)\right)$.

Since the joint distribution of the model parameters cannot be derived analytically (except in the simplest of cases), the distribution of $\theta$ is approximated using simulation techniques. For each treatment arm and subgroup, the PSA produces $n$ random draws from the posterior distribution of clinicial effectiveness and costs,

$$
\begin{aligned}
e_{sj} &= [e_{sj}^1, e_{sj}^2, \dots, e_{sj}^n] \\
c_{sj} &= [c_{sj}^1, c_{sj}^2, \dots, c_{sj}^n].
\end{aligned}
$$

#### Probability most cost-effective
A number of measures have been proposed in the health economics literature to summarize output from a PSA. A common measure is the probability that each treatment arm is the most cost effective. For a particular subgroup, this is estimated from simulation output as the proportion of simulation draws that each arm has the highest net benefits. For example, consider the table below showing net benefits for 3 arms obtained from a simulation of size 10. 

```{r mce_example_setup, echo = FALSE, results = "hide"}
```

```{r mce_example, echo = 2}
```

Treatments 1, 2, and 3 have the highest net benefits a fraction `r mce[1]`, `r mce[2]`, and `r mce[3]` of the time respectively.

#### Value of perfect information
One draw back of the previous measure is that it ignores the magnitude of cost or QALY gains. A measure which combines the probability of being most effective with the magnitude of the expected net benefit is the expected value of perfect information (EVPI). Intuitively, the EVPI provides an estimate of the amount that we would be willing to pay to collect additional data and completely eliminate uncertainty. Mathematically, the EVPI is defined as the difference between the expected net benefit given perfect information (ENBPI) and the expected net benefit (ENB),

$$
\begin{aligned}
EVPI &= \int_s NB(j^{s*}, \theta^s) - NB(j^{*}, \theta^s) \\
&= ENBPI - ENB
\end{aligned}
$$

#### Cost-effectiveness plane

#### Cost-effectiveness acceptability curve (CEAC)

### PSA with the CEA package
For example, we can simulate results from three hypothetical treatments. We use $1$ to refer to the existing therapy, and $2$, and $3$ to refer to competing treatment arms. 

```{r ce_output}
```

For a given willingess to pay $k$, it is quite easy to determine the optimal treatment by estimating the expected net benefit for each arm. For example, for $W = 150,000$, which is a reasonable estimate of the value of a life-year in the United States, we can calculate, $\text{E}[e] \cdot w - \text{E}[c]$ 

```{r enb_example}
```

The expected net benefit is largest for arm 3, which implies that if the willingess to pay for a QALY is $150,000, patients should switch to this new treatment. 

The function `pcea` makes this calculation for various values of $k$. Output is a tidy *data.table*, which facilitates plotting with *ggplot2*.

```{r pcea}
```

MCE plot
```{r mce_plot, fig.cap = "Probability each arm is most cost-effective by subgroup"}
```

EVPI plot

```{r evpi_plot, fig.cap = "Expected value of perfect information by subgroup"}
```

In most analyses, the analyst will want estimates of the probability that each treatment is most cost-effective and and EVPI. The function ``psa`` is a wrapper for the ``evpi`` and ``mce`` functions. It also provides a summary table of means and credible intervals for both QALYs and costs. Finally, the user has the option to specify a custom table of summary output. The custom table can contain any quantities of interest (QOIs) as long as they are specified in addition to the sim, arm, e, and c columns in the posterior distribution data table. The default is to estimate means, the 2.5% quantile, and the 97.5% quantile for each variable, but any custom function can used. Below, we create a hyothetical variable for life-years and create table summarizing our estimates of costs, QALYs and life-years. A custom function, identical to the default option, is entered into the function for illustrative purposes.

```{r pcea_pw}
```

Cost-effectiveness plane

```{r ceplane_plot, fig.cap = "Cost-effectiveness plane by subgroup"}
```

Cost-effectiveness acceptability curve

```{r ceac_plot, fig.cap = "Cost-effectiveness acceptability curve by subgroup"}
```

ICER

```{r icer}
```

### Pairwise comparisons

## Simulating Disease Progression 

## References

